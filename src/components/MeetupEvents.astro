---
// MeetupEvents component to display past events from Meetup.com
---

<div class="bg-gray-900 py-24 sm:py-32">
  <div class="mx-auto max-w-7xl px-6 lg:px-8">
    <div class="mx-auto max-w-2xl text-center">
      <h2 class="text-4xl font-semibold tracking-tight text-balance text-white sm:text-5xl">
        Past Events
      </h2>
      <p class="mt-2 text-lg/8 text-gray-400">
        Check out what we've covered in previous meetups.
      </p>
    </div>
    
    <div id="past-events" class="mx-auto mt-16 grid max-w-2xl auto-rows-fr grid-cols-1 gap-8 sm:mt-20 lg:mx-0 lg:max-w-none lg:grid-cols-3">
      <!-- Events will be populated by JavaScript -->
    </div>
  </div>
</div>

<script>
  // Meetup API endpoints - using GraphQL for consistency
  const GROUP_URLNAME = 'nashville-ai-engineering';

  // Format date for display
  function formatEventDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric'
    });
  }

  // Create past event card HTML in blog style
  function createPastEventCard(event) {
    const eventDate = formatEventDate(event.time);
    const rsvpCount = event.yes_rsvp_count || 0;
    
    return `
      <article class="relative isolate flex flex-col justify-end overflow-hidden rounded-2xl bg-gray-800 px-8 pt-80 pb-8 sm:pt-48 lg:pt-80">
        <div class="absolute inset-0 -z-10 bg-gradient-to-br from-indigo-500/20 to-purple-600/20"></div>
        <div class="absolute inset-0 -z-10 rounded-2xl inset-ring inset-ring-white/10"></div>
        
        <div class="flex flex-wrap items-center gap-y-1 overflow-hidden text-sm/6 text-gray-300">
          <time datetime="${new Date(event.time).toISOString()}" class="mr-8">${eventDate}</time>
          <div class="-ml-4 flex items-center gap-x-4">
            <svg viewBox="0 0 2 2" class="-ml-0.5 size-0.5 flex-none fill-gray-300/50">
              <circle r="1" cx="1" cy="1"></circle>
            </svg>
            <div class="flex gap-x-2.5">
              <div class="size-6 flex-none rounded-full bg-indigo-500/20 flex items-center justify-center">
                <svg class="w-4 h-4 text-indigo-400" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                </svg>
              </div>
              ${rsvpCount} attended
            </div>
          </div>
        </div>
        
        <h3 class="mt-3 text-lg/6 font-semibold text-white">
          <a href="${event.link}" target="_blank" rel="noopener noreferrer">
            <span class="absolute inset-0"></span>
            ${event.name}
          </a>
        </h3>
        
        ${event.description ? `<p class="mt-2 text-sm text-gray-400 line-clamp-3">${event.description.replace(/<[^>]*>/g, '').substring(0, 150)}...</p>` : ''}
      </article>
    `;
  }

  // Fetch and display past events using GraphQL
  async function fetchPastEvents() {
    try {
      console.log('Fetching past events via GraphQL...');
      
      // Get the container element
      const pastContainer = document.getElementById('past-events');
      
      // Use GraphQL API for past events
      const graphqlResponse = await fetch('https://api.meetup.com/gql', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          query: `
            query {
              groupByUrlname(urlname: "${GROUP_URLNAME}") {
                pastEvents(input: {first: 10}) {
                  edges {
                    node {
                      id
                      title
                      dateTime
                      eventUrl
                      going
                      maxTickets
                    }
                  }
                }
              }
            }
          `
        })
      });
      
      if (graphqlResponse.ok) {
        const graphqlData = await graphqlResponse.json();
        console.log('GraphQL past events data:', graphqlData);
        
        const events = graphqlData?.data?.groupByUrlname?.pastEvents?.edges || [];
        if (events.length > 0) {
          console.log('Found', events.length, 'past events via GraphQL');
          const transformedEvents = events.map(edge => ({
            name: edge.node.title,
            time: edge.node.dateTime,
            link: edge.node.eventUrl,
            yes_rsvp_count: edge.node.going,
            rsvp_limit: edge.node.maxTickets
          }));
          
          pastContainer.innerHTML = transformedEvents
            .slice(0, 6)
            .map(event => createPastEventCard(event))
            .join('');
        } else {
          console.log('No past events found');
          pastContainer.innerHTML = `
            <div class="col-span-3 text-center py-12">
              <p class="text-gray-400">No past events yet. Check back soon!</p>
            </div>
          `;
        }
      } else {
        console.error('GraphQL request failed:', graphqlResponse.status);
        pastContainer.innerHTML = `
          <div class="col-span-3 text-center py-12">
            <p class="text-gray-400">Unable to load events. Please try again later.</p>
          </div>
        `;
      }
      
    } catch (error) {
      console.error('Error fetching Meetup events:', error);
      
      // Show error state
      document.getElementById('past-events').innerHTML = `
        <div class="col-span-3 text-center py-12">
          <p class="text-gray-400">Unable to load events. Please try again later.</p>
        </div>
      `;
    }
  }

  // Fetch events on page load
  fetchPastEvents();
  
  // Refresh events every hour
  setInterval(fetchPastEvents, 60 * 60 * 1000);
</script>
